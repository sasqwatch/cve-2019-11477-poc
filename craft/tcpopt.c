#include "tcpopt.h"

const char *type_name[] = {
  " ",
  "No Operation",
  "Maximum Segment Size",
  "Window Scale",
  "SACK Permitted",
  "SACK",
  " ",
  " ",
  "Timestamp"
};

const char *get_type_name(int type)
{
  return type_name[type];
}

uint64_t get_value(uint8_t *p, int len)
{
  int i;
  uint64_t ret;

  ret = 0;
  for (i=0; i<len; i++)
  {
    ret = (ret << 8) | p[i];
  }

  return ret;
}

struct tcpopt_st *init_tcpopt_block(void)
{
  struct tcpopt_st *ret;
  ret = (struct tcpopt_st *)malloc(sizeof(struct tcpopt_st));
  memset(ret, 0x0, sizeof(struct tcpopt_st));

  return ret;
}

struct tcpopt_st *get_tcpopt_blocks(struct tcphdr *tcph)
{
  int idx, optlen, len;
  struct tcpopt_st *head, *prev, *ptr;
  uint8_t *opt;

  head = prev = ptr = NULL;
  optlen = tcph->doff * 4 - 20;
  opt = (uint8_t *)tcph + 20;
  idx = 0;

  while (idx < optlen)
  {
    ptr = init_tcpopt_block();
    ptr->type = opt[idx++];

    if (ptr->type == TCPOPT_NO_OPERATION)
      len = 0;
    else
      len = opt[idx++];

    if (len > 2)
    {
      ptr->val = get_value(opt + idx, len - 2);
      idx += len - 2;
    }

    if (prev)
    {
      prev->next = ptr;
      prev = ptr;
    }

    if (!head)
      head = prev = ptr;
  }
  
  return head;
}

int modify_tcpopt_block(struct tcpopt_st *head, int type, int val)
{
  return SUCCESS;
}

void print_tcpopt_blocks(struct tcpopt_st *head)
{
  struct tcpopt_st *ptr;
  ptr = head;

  while (ptr)
  {
    printf("Type: %s / Value: %lu\n", get_type_name(ptr->type), ptr->val);
    ptr = ptr->next;
  }
}
