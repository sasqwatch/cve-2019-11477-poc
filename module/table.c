#include "table.h"
#include "../../include/kdebug.h"

#define TRUE 1
#define FALSE 0

int init_elem(struct elem *e, struct connection_info_st *conn_info)
{
  e->saddr = conn_info->saddr;
  e->sport = conn_info->sport;
  e->daddr = conn_info->daddr;
  e->dport = conn_info->dport;
  e->caddr = conn_info->caddr;
  e->cport = conn_info->cport;

  return SUCCESS;
}

int register_elem_to_table(struct elem *e, struct elem *table)
{
  kfstart();
  list_add(&e->list, &table->list);
  kffinish();
  return SUCCESS;
}

struct elem *find_elem_from_table(struct connection_info_st *conn_info,
    struct elem *table)
{
  struct elem *e;
  struct list_head *p;
  uint8_t found = FALSE;
  e = NULL, p = NULL;
  
  list_for_each(p, &table->list)
  {
    e = list_entry(p, struct elem, list);

    // receive case
    if ((e->saddr == conn_info->saddr) &&
        (e->sport == conn_info->sport) &&
        (e->daddr == conn_info->daddr) &&
        (e->dport == conn_info->dport))
    {
      found = TRUE;
      break;
    }

    // send case
    if ((e->caddr == conn_info->saddr) &&
        (e->cport == conn_info->sport) &&
        (e->saddr == conn_info->daddr) &&
        (e->sport == conn_info->dport))
    {
      found = TRUE;
      break;
    }
  }

  if (found == FALSE)
  {
    e = NULL;
  }

  return e;
}

void delete_elem_from_table(struct connection_info_st *conn_info, struct elem *table)
{
  struct elem *e;

  kfstart();
  e = find_elem_from_table(conn_info, table);

  if (e)
  {
    list_del(&e->list);
    kfree(e);
  }
  kffinish();
}
